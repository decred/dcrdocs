# Hybrid Design 

---

Основным отличием от ранее описанной схемы  follow-the-satoshi[^1] является новая лотерейная система, в которой тикеты необходимо приобрести, а затем ожидать в течение срока созревания до того момента, как их можно будет отобрать и потратить. Отбор тикетов для блока осуществляется лексикографически из пула готовых тикетов на основе псевдослучайности, содержащейся в заголовке блока. Поскольку манипуляция этой псевдослучайностью в системе PoW затруднена, манипулирование выбором тикета связано с существенными затратами для майнера PoW. Выбор тикетов за период времени может быть описан с помощью функции плотности вероятности подобной вероятности получения блока в PoW при постоянной скорости хеширования за период времени при постоянной сложности[^2], что дает распределение вероятности в режиме приблизительно равном половине размера тикет-пула. Цена покупки тикета регулируется новой сложностью, которая определяется экспоненциально взвешенным средним количеством купленных тикетов и размером пула готовых тикетов в предыдущих блоках.

Проверка блоков PoW может быть объяснена при помощи следующих шагов:

1. Блок запускается майнером PoW, который выбирает транзакции для размещения в нем. Транзакции, связанные с системой ставок, размещены в UTXO set.
2. POS-майнеры голосуют по блоку, производя vote-транзакцию по своим тикетам. Vote позволяет как блоку быть построенным поверх предыдущего блока, так и определяет, является ли действующим предыдущее регулярное дерево транзакций (содержащее койнбазу и транзакции, не связанные со stake).
3. Еще один PoW-майнер начинает создавать блок, включая голоса PoS-майнеров. Большинство поданных голосов должны быть включены в следующий блок для того, чтобы этот блок был принят сетью. По vote-транзакциям в этом новом блоке PoW-майнер проверяет флажок, чтобы узнать, указал ли PoS-майнер, что регулярное дерево транзакций блока было действующим. Эти флаги голосования подсчитываются и, основываясь на большинстве голосов, в этом блоке устанавливается бит-флаг, указывающий валидность регулярного дерева транзакций предыдущего блока.
4. Находится nonce, который удовлетворяет сложность сети, и блок вставляется в блокчейн. Если регулярное дерево транзакции предыдущего блока было действующим, вставляет эти транзакции в UTXO set. Переходит к пункту 1.

Чтобы исключить манипулирование включенными голосами, к текущему блоку применяется штраф линейной субсидии, если они не могут включить в свой блок все голосующие транзакции. "Программное" наказание, отказ в признании предыдущего дерева транзакций действительным, помогает предотвратить ухудшение работы, необходимой для обеспечения безопасности системы, и осуществляет допущение, что следующий блок будет получен майнером, который не будет заинтересован в сохранении субсидии прежнего блока в пользу своих собственных. Даже в случае, если это неверно, злоумышленник с высокой уровнем хэширования по-прежнему будет нуждаться по меньшей мере в \((\text{number for majority}/2)+1\) голосов в пользу дерева транзакций своего предыдущего блока, что бы создать блок, который даст им какую-либо субсидию от предыдущего блока.

Бит-флаги четко и ясно добавляются и к заголовку блоков, и к votes, чтобы майнер мог легко проголосовать в новых, как hard, так и soft форках.

---

## <i class="fa fa-book"></i> Ссылки 

[^1]: Bentov I., Lee C., Mizrahi A., Rosenfeld M. 2014. [Proof-of-activity: Extending Bitcoin's proof-of-work via proof-of-stake](https://decred.org/research/bentov2014.pdf).
[^2]: Nakamoto S. 2008. [Bitcoin: A peer-to-peer electronic cash system](https://decred.org/research/nakamoto2008.pdf).
